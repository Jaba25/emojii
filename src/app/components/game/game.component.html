<ion-header [translucent]="true" class="safe-area-header">
  <div class="header-safe-area"></div>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-button (click)="goBackToMenu()">
        <ion-icon name="arrow-back-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>{{ categoryTitle }}</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="goToMainPage()">
        <ion-icon name="home-outline" slot="start"></ion-icon>
        მთავარი
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="game-content safe-area-content" *ngIf="gameState">
  
  <!-- Game Status Bar -->
  <div class="status-bar">
    
    <!-- Progress -->
    <div class="progress-section">
      <div class="progress-label">
        კითხვა {{ gameState.currentQuestionIndex + 1 }} / {{ gameState.questions.length }}
      </div>
      <ion-progress-bar 
        [value]="getProgressPercentage() / 100" 
        color="secondary">
      </ion-progress-bar>
    </div>

    <!-- Coins and Score -->
    <div class="stats-row">
      <div class="coins-section">
        <span class="coins-label">🪙 მონეტები:</span>
        <span class="coins-value">{{ gameState.coins }}</span>
      </div>
      
      <div class="score-section">
        <span class="score-label">ქულა:</span>
        <span class="score-value">{{ gameState.score }}</span>
      </div>
    </div>

  </div>

  <!-- Question Section -->
  <div class="question-container" *ngIf="gameState.currentQuestion">
    
    <!-- Emoji Display -->
    <div class="emoji-display" [class]="category + '-category'">
      <div class="emoji-text" [class.long-sequence]="isLongEmojiSequence()">{{ gameState.currentQuestion.emojis }}</div>
      <div class="difficulty-badge" [class]="'difficulty-' + gameState.currentQuestion.difficulty">
        {{ getDifficultyText(gameState.currentQuestion.difficulty) }}
      </div>
    </div>

    <!-- Hint Options Section -->
    <div class="hint-options-section" *ngIf="showHintOptions">
      <ion-card class="hint-options-card">
        <ion-card-content>
          <div class="hint-options-header">
            <div class="hint-icon">💡</div>
            <ion-button 
              fill="clear" 
              size="small" 
              (click)="closeHintOptions(); $event.stopPropagation()"
              class="close-button">
              <ion-icon name="close-outline"></ion-icon>
            </ion-button>
          </div>
          <div class="hint-options-title">აირჩიე მინიშნების ტიპი:</div>
          
          <div class="hint-buttons">
            <ion-button 
              expand="block" 
              class="hint-level-button easy-hint"
              [disabled]="!canUseHint('easy')"
              (click)="useHint('easy')">
              <div class="hint-button-content">
                <div class="hint-level">მარტივი მინიშნება</div>
                <div class="hint-cost">10 🪙</div>
                <div class="hint-description">ზოგადი მინიშნება</div>
              </div>
            </ion-button>

            <ion-button 
              expand="block" 
              class="hint-level-button medium-hint"
              [disabled]="!canUseHint('medium')"
              (click)="useHint('medium')">
              <div class="hint-button-content">
                <div class="hint-level">საშუალო მინიშნება</div>
                <div class="hint-cost">20 🪙</div>
                <div class="hint-description">კონკრეტული მინიშნება</div>
              </div>
            </ion-button>

            <ion-button 
              expand="block" 
              class="hint-level-button hard-hint"
              [disabled]="!canUseHint('hard')"
              (click)="useHint('hard')">
              <div class="hint-button-content">
                <div class="hint-level">რთული მინიშნება</div>
                <div class="hint-cost">30 🪙</div>
                <div class="hint-description">ძლიერი მინიშნება</div>
              </div>
            </ion-button>
          </div>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Active Hint Section -->
    <div class="hint-section" *ngIf="showHint">
      <ion-card class="hint-card">
        <ion-card-content>
          <div class="hint-header">
            <div class="hint-info">
              <div class="hint-icon">💡</div>
              <div class="hint-level-label">{{ getHintLevelText() }}</div>
            </div>
            <ion-button 
              fill="clear" 
              size="small" 
              (click)="closeHint(); $event.stopPropagation()"
              class="close-button">
              <ion-icon name="close-outline"></ion-icon>
            </ion-button>
          </div>
          <div class="hint-text">{{ currentHint }}</div>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Revealed Answer Section -->
    <div class="answer-reveal-section" *ngIf="showRevealedAnswer">
      <ion-card class="answer-reveal-card">
        <ion-card-content>
          <div class="answer-header">
            <div class="answer-icon">📖</div>
            <ion-button 
              fill="clear" 
              size="small" 
              (click)="closeRevealedAnswer()"
              class="close-button">
              <ion-icon name="close-outline" style="color: white;"></ion-icon>
            </ion-button>
          </div>
          <div class="answer-label">პასუხი:</div>
          <div class="answer-text">{{ revealedAnswer }}</div>
          
          <!-- Next Question Button -->
          <ion-button 
            class="next-question-button"
            expand="block" 
            (click)="goToNextQuestion()"
            color="success">
            შემდეგი კითხვა ➡️
          </ion-button>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Answer Section - Only show when hint, hint options and revealed answer are not shown -->
    <div class="answer-section" *ngIf="!showHint && !showHintOptions && !showRevealedAnswer">
      
      <!-- Answer Label -->
      <div class="answer-label">შენი პასუხი:</div>
      
      <!-- Letter Boxes Container -->
      <div class="answer-boxes-container" (click)="focusHiddenInput()">
        <div 
          *ngFor="let letterData of letterBoxes; let i = index"
          class="letter-box"
          [class.filled]="letterData.userLetter"
          [class.correct]="letterData.isCorrect"
          [class.incorrect]="letterData.isIncorrect"
          [class.space-after]="letterData.spaceAfter">
          {{ letterData.userLetter }}
        </div>
      </div>

      <!-- Completely Hidden Input Field (triggers keyboard) -->
      <input 
        #hiddenInput
        type="text" 
        [(ngModel)]="userAnswer"
        (input)="onAnswerChange($event)"
        (keydown)="onKeyDown($event)"
        (keyup)="onKeyUp($event)"
        (compositionstart)="onCompositionStart($event)"
        (compositionupdate)="onCompositionUpdate($event)"
        (compositionend)="onCompositionEnd($event)"
        (focus)="onInputFocus()"
        (blur)="onInputBlur()"
        autocomplete="off"
        autocorrect="off"
        autocapitalize="off"
        spellcheck="false"
        inputmode="text"
        lang="ka"
        enterkeyhint="done"
        class="completely-hidden-input">

    </div>

    <!-- Action Buttons - Hide when hint options or hint is shown -->
    <div class="action-buttons" *ngIf="!showRevealedAnswer && !showHintOptions && !showHint">
      
      <!-- Action Buttons Row -->
      <div class="action-buttons">
        <!-- Hint Button -->
        <ion-button 
          expand="block"
          (click)="showHintOptions = true"
          class="hint-button"
          style="--background: #ff9800 !important; --color: #ffffff !important; --border-radius: 16px !important; background: #ff9800 !important; color: #ffffff !important; border-radius: 16px !important; box-shadow: 0 6px 20px rgba(255, 152, 0, 0.4) !important;">
          მინიშნება
        </ion-button>

        <!-- Show Answer Button -->
        <ion-button 
          expand="block"
          (click)="showAnswer()"
          [disabled]="!canAffordShowAnswer()"
          class="show-answer-button"
          style="--background: #f44336 !important; --color: #ffffff !important; --border-radius: 16px !important; background: #f44336 !important; color: #ffffff !important; border-radius: 16px !important; box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4) !important;">
          პასუხი - 50🪙
        </ion-button>
      </div>

      <!-- Submit Button or Clear Button -->
      <ion-button 
        *ngIf="!showAnswerResult || isAnswerCorrect"
        expand="block" 
        color="success"
        (click)="submitAnswer()"
        [disabled]="!userAnswer.trim()"
        class="submit-button">
        პასუხის გაგზავნა
      </ion-button>

      <!-- Clear/Try Again Button for incorrect answers -->
      <ion-button 
        *ngIf="showAnswerResult && !isAnswerCorrect"
        expand="block" 
        color="danger"
        (click)="clearIncorrectAnswer()"
        class="clear-button">
        სცადე კიდევ
      </ion-button>
      
    </div>

  </div>

  <!-- Game Over State -->
  <div class="game-over-container" *ngIf="gameState.gameStatus === 'finished'">
    <div class="game-over-content">
      <div class="game-over-icon">🎮</div>
      <h2>თამაში დასრულდა!</h2>
      <p>შენი საბოლოო ქულა: <strong>{{ gameState.score }}</strong></p>
      <ion-button 
        expand="block" 
        color="primary"
        (click)="goBackToMenu()">
        მთავარ მენიუში დაბრუნება
      </ion-button>
    </div>
  </div>

  <!-- Bottom Safe Area -->
  <div class="bottom-safe-area"></div>

</ion-content>

<!-- Loading State -->
<ion-content *ngIf="!gameState" class="loading-content safe-area-content">
  <div class="loading-container">
    <ion-spinner name="crescent" color="primary"></ion-spinner>
    <p>თამაში იტვირთება...</p>
  </div>
  <div class="bottom-safe-area"></div>
</ion-content>
